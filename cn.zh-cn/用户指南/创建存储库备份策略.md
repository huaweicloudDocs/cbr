# 创建存储库备份策略<a name="cbr_03_0025"></a>

通过备份策略，您可以将整个存储库绑定的资源按照一定的策略要求，对资源的数据进行周期性备份，以便服务器在数据丢失或损坏时快速恢复数据，保证业务正常运行。

当需要定期备份存储库时，首先需要创建一个备份策略，系统根据您的备份策略决定何时执行备份任务。您可以使用系统提供的默认备份策略，也可以结合实际情况，创建新的自定义备份策略。

可以为云服务器备份存储库、SFS Turbo备份存储库和云硬盘备份存储库设置备份策略。

## 背景信息<a name="section3333171185517"></a>

-   通过备份策略的方式对资源进行周期性备份，仅当启用备份策略后，系统才会自动备份所绑定的存储库绑定的资源，并定期删除过期的备份。
-   每个用户最多只能创建32个备份策略。
-   设置备份时间和复制备份的时间时，尽量在确保备份策略执行完毕备份任务已完成后再执行复制策略，否则可能会出现复制备份失败的情况。
-   删除过期自动备份数据不会删除手动备份数据。
-   只有“运行中”和“关机”状态的服务器才可进行备份。
-   只有“可用”或“正在使用”状态的磁盘才可进行备份。

## 操作步骤<a name="section994083714511"></a>

1.  登录云备份管理控制台。
    1.  登录管理控制台。
    2.  单击管理控制台左上角的![](figures/icon-region.png)，选择区域和项目。
    3.  选择“存储 \> 云备份”。选择对应备份的页签。

2.  选择“备份策略”页签，单击右上角“创建策略”，创建自定义策略。如[图1](#fig83663164139)所示。

    **图 1**  创建备份策略<a name="fig83663164139"></a>  
    

    ![](figures/Snipaste_2021-08-03_17-02-38.png)

3.  设置备份策略信息。各参数说明如[表1](#table18975142115146)所示。

    **表 1**  备份策略参数说明

    <a name="table18975142115146"></a>
    <table><thead align="left"><tr id="row1997514210149"><th class="cellrowborder" valign="top" width="16.161616161616163%" id="mcps1.2.4.1.1"><p id="p13976421151411"><a name="p13976421151411"></a><a name="p13976421151411"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="50.505050505050505%" id="mcps1.2.4.1.2"><p id="p1497652113146"><a name="p1497652113146"></a><a name="p1497652113146"></a>说明</p>
    </th>
    <th class="cellrowborder" valign="top" width="33.333333333333336%" id="mcps1.2.4.1.3"><p id="p1597662113147"><a name="p1597662113147"></a><a name="p1597662113147"></a>示例</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row1084012355149"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p1084003512148"><a name="p1084003512148"></a><a name="p1084003512148"></a>类型</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p084017358142"><a name="p084017358142"></a><a name="p084017358142"></a>选择策略类型。本章节以创建备份策略为例。</p>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p984003521410"><a name="p984003521410"></a><a name="p984003521410"></a>备份策略</p>
    </td>
    </tr>
    <tr id="row4976122191416"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p6976162141412"><a name="p6976162141412"></a><a name="p6976162141412"></a>名称</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p18976321111413"><a name="p18976321111413"></a><a name="p18976321111413"></a>设置备份策略的名称。</p>
    <p id="p79769215148"><a name="p79769215148"></a><a name="p79769215148"></a>只能由中文字符、英文字母、数字、下划线、中划线组成，且长度小于等于64个字符。</p>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p1697662117143"><a name="p1697662117143"></a><a name="p1697662117143"></a>backup_policy</p>
    </td>
    </tr>
    <tr id="row1248223165716"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p104838317576"><a name="p104838317576"></a><a name="p104838317576"></a>是否启用</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p548333175713"><a name="p548333175713"></a><a name="p548333175713"></a>设置备份策略的启用状态。</p>
    <a name="ul14659163365820"></a><a name="ul14659163365820"></a><ul id="ul14659163365820"><li>启用：<a name="image1743441913819"></a><a name="image1743441913819"></a><span><img id="image1743441913819" src="figures/icon-on.png"></span></li><li>禁用：<a name="image192651120192716"></a><a name="image192651120192716"></a><span><img id="image192651120192716" src="figures/icon-off.png"></span></li></ul>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p177641181715"><a name="p177641181715"></a><a name="p177641181715"></a>仅当启用备份策略后，系统才会自动备份所绑定的存储库的服务器和磁盘，并定期删除过期的备份。</p>
    </td>
    </tr>
    <tr id="row1631531981516"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p331615194152"><a name="p331615194152"></a><a name="p331615194152"></a>备份时间</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p14316419131512"><a name="p14316419131512"></a><a name="p14316419131512"></a>设置备份任务在一天之内的执行时间点。</p>
    <p id="p1445292591817"><a name="p1445292591817"></a><a name="p1445292591817"></a>只支持在整点进行备份，同时支持选择多个整点进行备份。</p>
    <div class="notice" id="note177121113141017"><a name="note177121113141017"></a><a name="note177121113141017"></a><span class="noticetitle"> 须知： </span><div class="noticebody"><p id="p13381536104420"><a name="p13381536104420"></a><a name="p13381536104420"></a>如需要备份的资源总数据量较大，建议备份执行时间点不宜设置过于紧密。如果单个资源执行备份的时长超过两个备份执行时间间隔，则会跳过第二个备份时间点不进行备份。</p>
    <p id="p107121613201018"><a name="p107121613201018"></a><a name="p107121613201018"></a>例如：某磁盘的备份策略设置的备份时间点为：00:00，01:00，02:00。在00:00时，磁盘开始进行备份，由于磁盘此次备份增量数据较大，或者该时间段同时执行的备份任务较多，该次备份任务耗时90分钟，在01:30时完成备份。则01:00的备份时间点会跳过，在02:00时再执行备份，将只会产生两个备份。</p>
    </div></div>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p631620196155"><a name="p631620196155"></a><a name="p631620196155"></a>00:00，02:00</p>
    <p id="p19767124972810"><a name="p19767124972810"></a><a name="p19767124972810"></a>建议选择无业务或者业务量较少的时间进行备份。</p>
    </td>
    </tr>
    <tr id="row1771214375511"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p3712532556"><a name="p3712532556"></a><a name="p3712532556"></a>时区</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p8850651115616"><a name="p8850651115616"></a><a name="p8850651115616"></a>设置执行备份时间的时区。可以将备份时间点设置在其他的时区。默认情况下，时区与用户所在地时区一致。</p>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p822695315511"><a name="p822695315511"></a><a name="p822695315511"></a>UTC+08:00</p>
    </td>
    </tr>
    <tr id="row8447021201515"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p12447122111511"><a name="p12447122111511"></a><a name="p12447122111511"></a>备份周期</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p2099535614183"><a name="p2099535614183"></a><a name="p2099535614183"></a>设置备份任务的执行日期。</p>
    <a name="ul172457131819"></a><a name="ul172457131819"></a><ul id="ul172457131819"><li>按周<p id="p139243216106"><a name="p139243216106"></a><a name="p139243216106"></a>指定备份策略在每周的周几进行备份，可以多选。</p>
    </li><li>按天<p id="p1658419416118"><a name="p1658419416118"></a><a name="p1658419416118"></a>指定备份策略每隔几天进行一次备份，可设置1～30天。</p>
    </li></ul>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p20229131519311"><a name="p20229131519311"></a><a name="p20229131519311"></a>每1天</p>
    <p id="p35261251144815"><a name="p35261251144815"></a><a name="p35261251144815"></a>当选择按天备份时，理论上第一次备份的时间为备份策略创建当天。如果当天备份策略创建的时间已经晚于设置的备份时间，那么将会等到第二个备份周期再进行第一次备份。</p>
    <p id="p780882374520"><a name="p780882374520"></a><a name="p780882374520"></a>建议选择无业务或者业务量较少的时间进行备份。</p>
    </td>
    </tr>
    <tr id="row9482950131718"><td class="cellrowborder" valign="top" width="16.161616161616163%" headers="mcps1.2.4.1.1 "><p id="p1648219506178"><a name="p1648219506178"></a><a name="p1648219506178"></a>保留规则</p>
    </td>
    <td class="cellrowborder" valign="top" width="50.505050505050505%" headers="mcps1.2.4.1.2 "><p id="p9482850191713"><a name="p9482850191713"></a><a name="p9482850191713"></a>设置备份产生后的保留规则。</p>
    <a name="ul1544815182330"></a><a name="ul1544815182330"></a><ul id="ul1544815182330"><li>按时间<p id="p493811214366"><a name="p493811214366"></a><a name="p493811214366"></a>可选择1个月、3个月、6个月、1年的固定保留时长或根据需要自定义保留时长。取值范围为2～99999天。</p>
    </li><li>按数量<p id="p5958151317388"><a name="p5958151317388"></a><a name="p5958151317388"></a>单个云服务器执行备份策略保留的备份总份数。取值范围为2～99999个。</p>
    </li><li>高级配置<p id="p6857171719502"><a name="p6857171719502"></a><a name="p6857171719502"></a>同时你还可以设置长期保留规则，且长期保留配置与按数量保留之间没有相互影响，共同有效：</p>
    <a name="ul143454010416"></a><a name="ul143454010416"></a><ul id="ul143454010416"><li>保留日备份：取值范围为0-100。</li><li>保留周备份：取值范围为0-100。</li><li>保留月备份：取值范围为0-100。</li><li>保留年备份：取值范围为0-100。</li></ul>
    <p id="p19619102842411"><a name="p19619102842411"></a><a name="p19619102842411"></a>例如：日备份，即系统会每天保留最新的一份备份。在本日内，对磁盘进行多次备份后，则只会取本日最后一个备份进行保留。若选择保留5个日备份，则会选取最新的5个日备份进行保留。超过5个后，系统会自动删除最老的备份。同时设置日备份、周备份、月备份和年备份，则会取并集备份进行保留。即设置保留日备份为5份，周备份1份时，会保留5份备份。长期保留规则与按数量保留可以同时执行，不会产生冲突。</p>
    </li><li>永久保留<div class="note" id="note5251621114717"><a name="note5251621114717"></a><a name="note5251621114717"></a><span class="notetitle"> 说明： </span><div class="notebody"><a name="ul513693919476"></a><a name="ul513693919476"></a><ul id="ul513693919476"><li>当保留的备份数超过设置的数值时，系统会自动删除最早创建的备份，当保留的备份超过设定的时间时，系统会自动删除所有过期的备份；系统默认每隔一天自动清理，删除的备份不会影响其他备份用于恢复。</li><li>保留规则仅对备份策略自动调度生成的备份有效。手动执行备份策略生成的备份不会统计在内，且不会自动删除。如需删除，请在备份页签的备份列表中手动删除。</li><li>当备份创建过镜像之后，该备份不会继续统计在保留规则中，也不会自动删除。</li><li>周期性备份产生的失败的备份最多保留10个，保留时长1个月，可手动删除。</li></ul>
    </div></div>
    </li></ul>
    </td>
    <td class="cellrowborder" valign="top" width="33.333333333333336%" headers="mcps1.2.4.1.3 "><p id="p1630841162417"><a name="p1630841162417"></a><a name="p1630841162417"></a>设置“按数量”保留3个备份，同时设置周备份规则为“保留最新产生备份1周内的每周最新的一个备份。”假如今天是30日，则这个策略的执行情况如<a href="#fig18385155316">图2</a>所示。</p>
    <a name="ul99134518237"></a><a name="ul99134518237"></a><ul id="ul99134518237"><li>标注时间的日期，为产生备份的日期。</li><li>灰色时间的备份已经被删除。</li><li>绿色时间的备份被保留下来。</li></ul>
    <p id="p1191345110236"><a name="p1191345110236"></a><a name="p1191345110236"></a>如果不设置周备份规则，则将只会有25日、26日和29日的备份会保留下来。</p>
    </td>
    </tr>
    </tbody>
    </table>

    **图 2**  保留规则设置高级选项示例图<a name="fig18385155316"></a>  
    ![](figures/保留规则设置高级选项示例图.png "保留规则设置高级选项示例图")

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >备份越频繁，保留的备份份数越多或时间越长，对数据的保护越充分，但是占用的存储库空间也越大。请根据数据的重要级别和业务量综合考虑选择，重要的数据采用较短的备份周期，且保留较多的备份份数或较长时间。

4.  设置完成后，单击“提交”，完成备份策略的创建。
5.  找到目标存储库，单击“更多 \> 设置备份策略”，绑定创建好的备份策略。可以在存储库详情中查看已配置的备份策略。

    绑定成功后，存储库将按照备份策略进行周期性备份。


## 示例<a name="section768255314712"></a>

某用户在星期一上午10:00设置某存储库策略A的备份时间为每天凌晨02:00，保留策略为按数量保留3份，该存储库绑定了一个磁盘。星期六上午11:00，保留策略保留了3个备份，分别为星期三、星期四和星期五产生的备份。星期二凌晨2：00产生的备份已经被系统自动删除。

